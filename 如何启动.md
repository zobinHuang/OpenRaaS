## 配置环境

### Docker

> Scheduler, Provider, Filestore, Depository

```bash
sudo apt-get update

sudo apt-get install docker-ce docker-ce-cli containerd.io
```

### Golang

> Provider

```bash
# 获取 go 并解压到 /usr/local
wget https://studygolang.com/dl/golang/go1.17.5.linux-amd64.tar.gz
sudo tar xfz go1.17.5.linux-amd64.tar.gz -C /usr/local

# 编辑系统配置文件
vim ~/.bashrc

# 配置 goroot（go 的安装目录），gopath（工作目录，放代码的地方，可自定义）
export GOROOT=/usr/local/go  
export GOPATH=~/Code
export PATH=$PATH:$GOROOT/bin 

# 重新执行初始化文件使修改后的新配置立即生效
source ~/.bashrc
```

### Nodejs

```bash
sudo apt update
sudo apt install nodejs npm
```

> Scheduler

## 1. 在 scheduler 节点上启动前端

```
cd web/ant-client-page
npm install
npm start
```

## 2. 在 scheduler 节点上启动 Nginx

Modify Nginx configuration file at <code>nginx/conf.d/static.conf</code>:

```nginx
upstream backstage{
    server [Ip and port of Global Master];
}

upstream web{
    server [Ip and port of Web frontend server];
}

server{
    listen 80;
    server_name [Server Domain];

    ...
```

Run OpenRaaS Nginx proxy:

```bash
sudo docker run --name nginx \
    --restart always \
    -p 80:80 \
    -v /home/broscloud/Code/OpenRaaS/nginx/logs:/var/log/nginx \
    -v /home/broscloud/Code/OpenRaaS/nginx/nginx.conf:/etc/nginx/nginx.conf \
    -v /home/broscloud/Code/OpenRaaS/nginx/conf.d:/etc/nginx/conf.d \
    -d nginx
```

## 3. 在 scheduler 节点上启动后端

```bash
cd backstage
sudo docker-compose up
```

## 4. 在 provider 节点上启动 serverd

注意，provider 中有两个后台进程，streamer 与 serverd：
- streamer 用于建立 user 与应用实例（容器）之间的 WebRTC 与 WebSocket 链接，同时由它直接与 scheduler 交互（包括节点上线）
- serverd 就是 provider 上的 daemon 程序，负责在 streamer 的调度下启动、管理、关闭应用实例（容器），并完成与 filestore、depository 的服务组合，同时由它来启动 streamer

因此，我们只需要启动 serverd 即可完成 provider 的部署

如果 `serverd` 二进制文件已经编译：

```bash
cd provider/serverd
sudo ./serverd
```

如果需要重新编译 `serverd` 文件：

1. 如果有，就先删掉 `go.mod` 和 `go.sum`
2. 运行 `go mod init serverd` 和 `go mod tidy`
3. 运行 `go build`
4. 运行 `sudo ./serverd` 二进制文件

## 5. 在 filestore 节点上启动 daemon

```bash
cd filestore
sudo docker-compose up
```

## 6. 在 depository 节点上启动 daemon

```bash
cd depository
sudo docker-compose up
```

## 5. 在 filestore 节点配置 APP

首先将 APP 移动到 `./filesotre/storage` 中



## 其他

一定要记得配置三个节点的 scheduler 设置，可以考虑写一个一键修改的脚本。

- Provider: `./provider/streamer/.env.dev`, `./provider/serverd/config`
    - [@zobinHuang](github.com/zobinHuang) 写的太乱了，streamer 上有些 scheduler 信息来自 serverd 的通知，有些又是用 os.Getenv 从 .env.dev 读出来的 
- Filestore: `./filestore/daemon/config.yaml`
- Depository: `./depository/daemon/config.yaml`
